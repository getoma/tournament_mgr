{% import 'base/form.twig' as form %}

{% include 'base/header.twig' with {
  'active_page': 'users.index'
}%}

<section>
  <h2>Aktive Nutzer</h2>
  <table class="entry-list">
    <thead>
      <tr>
      <th>Angezeigter Name</th>
      <th>E-Mail</th>
      <th>Rollen</th>
      <th>Letzter Login</th>
      <th>Aktionen</th>
      </tr>
    </thead>
    <tbody>
      {% for user in users|filter(u => u.is_active) -%}
      <tr>
      <td>{{user.display_name}}</td>
      <td>{{user.email}}</td>
      <td>{{user.roles|map(r => r.value)|join(', ')|humanize}}</td>
      <td>{% if user.last_login %}{{user.last_login|date('d.m.Y H:i')}}{% else %}---{% endif %}</td>
      <td>{% set buttons_active = policy.canModifyUser(user) -%}
          <a href="{{ url_for('users.show', {'userId': user.id}) }}" class="crud">
            {%- if buttons_active %}Bearbeiten{% else %}Details anzeigen{% endif -%}
          </a>
          {% if buttons_active -%}
          <form method="post" action="{{ url_for('users.delete', {'userId': user.id}) }}">
            <input type="hidden" name="_METHOD" value="DELETE">
            {{ form.submit('Löschen', confirm='%s wirklich löschen?'|format(user.display_name)) }}
          </form>
          {%- endif %}
      </td>
      </tr>
      {%- endfor %}
    </tbody>
  </table>
</section>

{% if users|find(u => not u.is_active) %}
<section>
  <h2>Deaktivierte Nutzer</h2>
  <table class="entry-list">
    <thead>
      <tr>
        <th>Angezeigter Name</th>
        <th>E-Mail</th>
        <th>Aktionen</th>
      </tr>
    </thead>
    <tbody>
      {% for user in users|filter(u => not u.is_active) -%}
      <tr>
        <td>{{user.display_name}}</td>
        <td>{{user.email}}</td>
      <td>{% set buttons_active = policy.canModifyUser(user) -%}
          <a href="{{ url_for('users.show', {'userId': user.id}) }}">{%if buttons_active%}Bearbeiten{%else%}Details anzeigen{%endif%}</a>
          {% if buttons_active -%}
          <form method="post" action="{{ url_for('users.delete', {'userId': user.id}) }}">
            <input type="hidden" name="_METHOD" value="DELETE">
            {{ form.submit('Löschen', confirm='%s wirklich löschen?'|format(user.display_name)) }}
          </form>
          {%- endif %}
      </td>
      </tr>
      {%- endfor %}
    </tbody>
  </table>
</section>
{% endif %}

<section>
  <p><a class="form-btn" href="{{url_for('users.create')}}">Neuen Benutzer anlegen</a></p>
</section>

{% include 'base/footer.twig' %}
